
<header style="padding-bottom: 10px; margin-bottom: 10px;">
	<h1 style="margin-bottom: 10px;">Movie Database</h1>
	<span>ruby / RoR / ActiveRecord / ActionController / sql / ajax / json / jquery</span>
</header>

<div id="my-app-view" style="border-top: 1px solid rgb(210,210,210);">
	<ol id="my-movie-list" class="in-a-hole"></ol>
	<ol id="my-actor-list" class="in-a-hole" style="margin-left:20px"></ol>
</div>

<style>
.in-a-hole {
	background: #ddd;
	box-shadow: inset 1px 0px 2px 1px #bebebe;
	border-radius: 10px;
}
ol.in-a-hole {
	display: inline-block; vertical-align:top;
	padding: 10px 15px 10px 30px;
}
</style>

<%= javascript_include_tag "underscore" %>
<%= javascript_include_tag "backbone" %>
<script>
$(document).ready(function(){
	/*
	regarding:
	. templating
	- in memory, .wrap() does not work
	- that's what javascript/jquery is for
	. oo
	- object named 'child'
	. events
	- user interaction events - forget about it
	. line count
	- approx. 50 to 130
	*/
	var movie_anchor_html = '<a href="javascript:void(0)" onclick="handleMovieClick(this)">';
	var movie_view = Backbone.View.extend({
		tagName: 'li',
		className: 'my-movie-view',
		render: function(){
			var movie = this.model.attributes;
			var $html = $(movie_anchor_html).append('<span>' + movie.title + '</span>');
			return this.$el.append($html).attr({id:movie.id});
		}
	})
	var actor_anchor_html = '<a href="javascript:void(0)" onclick="handleActorClick(this)">';
	var actor_view = Backbone.View.extend({
		tagName: 'li',
		className: 'my-actor-view',
		render: function(){
			var actor = this.model.attributes;
			var $html = $(actor_anchor_html).append('<span>' + actor.name + '</span>');
			return this.$el.append($html).attr({id:actor.id});
		}
	})
	var actor_collection = Backbone.Collection.extend({})
	var actor_list_view = Backbone.View.extend({
		el: $('#my-actor-list'),
		initialize: function(models, options){
			this.collection = new actor_collection(models, options);
			this.listenTo(this.collection, 'all', function(eventName){
			});
			this.listenTo(this.collection, 'request', function(collection, xhr, options){
			});	
			this.listenTo(this.collection, 'add', function(model, collection, options){
				this.addOne(model);
			});
			this.listenTo(this.collection, 'reset', function(collection, options){
				this.$el.empty();
			});
			this.listenTo(this.collection, 'sync', function(collection, resp, options){
			});
		},
		addOne: function(an_actor_model){
			var v = new actor_view({model: an_actor_model});
			this.$el.append(v.render());
		}
	})
	var movie_collection = Backbone.Collection.extend({})
	var movie_list_view = Backbone.View.extend({
		el: $('#my-movie-list'),
		initialize: function(models, options){
			this.collection = new movie_collection(models, options);
			this.listenTo(this.collection, 'all', function(){
			}),
			this.listenTo(this.collection, 'request', function(collection, xhr, options){
			});	
			this.listenTo(this.collection, 'add', function(model, collection, options){
				this.addOne(model);
			});
			this.listenTo(this.collection, 'reset', function(collection, options){
				this.$el.empty();
			});
			this.listenTo(this.collection, 'sync', function(collection, resp, options){
			});
			this.collection.each(this.addOne, this);
		},
		addOne: function(a_movie_model){
			var v = new movie_view({model: a_movie_model});
			this.$el.append(v.render());
		}
	})
	var my_actor_list_view = new actor_list_view;
	var my_movie_list_view = new movie_list_view(<%= raw(@movies.to_json) %>);
	window.handleMovieClick = function(a){
		var $selected_li = $(a).closest('li');
		var movie_id = $selected_li.attr('id');
		my_actor_list_view.collection.reset().fetch({
			$selected_li: $selected_li,
			url: "/movie/" + movie_id + "/actor_list",
			success: function(collection, resp, options){
				options.$selected_li.addClass('selected').find('a').children().unwrap();
				options.$selected_li.siblings().each(function(i, v){
					var $li = $(v).removeClass('selected');
					if(!$li.children('a').length){
						$li.children().wrap(movie_anchor_html);
					}
				})
			}
		});
		return false;
	}
	window.handleActorClick = function(a){
		var $selected_li = $(a).closest('li');
		var actor_id = $selected_li.attr('id');
		my_movie_list_view.collection.reset().fetch({
			$selected_li: $selected_li,
			url: "/actor/" + actor_id + "/movie_list",
			success: function(collection, resp, options){
				options.$selected_li.addClass('selected').find('a').children().unwrap();
				options.$selected_li.siblings().each(function(i, v){
					var $li = $(v).removeClass('selected');
					if(!$li.children('a').length){
						$li.children().wrap(actor_anchor_html);
					}
				})
			}
		});
		return false;
	}
	$('#my-movie-list li a').eq(0).click();  // select first one
	
	
	if(0){
		var movies = <%= raw(@movies.to_json) %>;

		function update_movie_list(movies){
			$('ol#my-movie-list').empty();
			$.each(movies, function(i, movie){
				var row = '<li id="' + movie.id + '"><a href="javascript:void(0)" onclick="select_movie(this)"><span>' + movie.title + '</span></a></li>';
				$('ol#my-movie-list').append(row);
			})		
		}
		function update_actor_list(cast){
			$('ol#my-actor-list').empty();
			$.each(cast, function(i, actor){
				var row = '<li id="' + actor.id + '"><a href="javascript:void(0)" onclick="select_actor(this)"><span>' + actor.name + '</span></a></li>';
				$('ol#my-actor-list').append(row);
			})		
		}

		window.select_movie = function(el){
			var movie_id = el.parentElement.id;
			var url = '/movie/' + movie_id + '/actor_list';
			$.getJSON(url, function(actors, textStatus, jqXHR){
				update_actor_list(actors);
			})
		
			$('ol#my-movie-list li').each(function(i, v){
				var $v = $(v), $label = $v.find('span');
				if($v.find('a').length){
					v.id == movie_id &&	$label.unwrap();
				} else {
					v.id == movie_id || $label.wrap('<a href="javascript:void(0)" onclick="select_movie(this)">');
				}
			});
		}
		window.select_actor = function(el){
			var actor_id = el.parentElement.id;
			var url = '/actor/' + actor_id + '/movie_list';
			$.getJSON(url, function(movies, textStatus, jqXHR){
				update_movie_list(movies);
			})

			$('ol#my-actor-list li').each(function(i, v){
				var $v = $(v), $label = $v.find('span');
				if($v.find('a').length){
					v.id == actor_id &&	$label.unwrap();
				} else {
					v.id == actor_id || $label.wrap('<a href="javascript:void(0)" onclick="select_actor(this)">');
				}
			});
		}
		update_movie_list(movies);
		$('ol#my-movie-list a').eq(0).trigger('click');  // default - click first movie
	}
})
</script>